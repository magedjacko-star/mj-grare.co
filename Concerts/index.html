<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Concerts | Michael Jackson</title>
  <style>
    :root{
      --red:#e50914; --bg:#000; --panel:#0b0b0b; --panel2:#111; --line:#1f1f1f;
      --muted:#b3b3b3; --sideW:240px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:#fff; font-family: Arial, sans-serif; }
    .wrap{ display:flex; min-height:100vh; }
    .sidebar{
      width:var(--sideW); background:linear-gradient(180deg,#070707,#000);
      border-right:1px solid rgba(255,255,255,.08); padding:18px 14px;
      position:sticky; top:0; height:100vh;
    }
    .sidebar a{
      display:block; padding:11px 12px; border-radius:10px;
      text-decoration:none; color:#fff; font-weight:700; opacity:.92; transition:.15s;
    }
    .sidebar a:hover{ background:rgba(229,9,20,.12); opacity:1; transform:translateX(2px); }
    .submenu{
      margin:10px 0 12px; padding:10px; border-radius:12px;
      background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08);
    }
    .submenu a{ font-weight:700; opacity:.9; padding:10px 10px; border-radius:10px; }
    .content{ flex:1; padding:26px; }
    .header{ max-width:1200px; margin:0 auto 14px; text-align:center; }
    h1{ color:var(--red); margin:8px 0 8px; font-size:40px; letter-spacing:.4px; }
    .sub{ color:var(--muted); margin:0 0 16px; font-size:14px; }
    .topbar{ max-width:1200px; margin:0 auto 18px; display:flex; justify-content:center; gap:12px; flex-wrap:wrap; }
    .search{
      width:min(560px, 92vw); padding:12px 14px; border-radius:12px;
      border:1px solid #2a2a2a; background:#0b0b0b; color:#fff; outline:none; font-size:15px;
    }
    .grid{
      max-width:1200px; margin:0 auto;
      display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap:18px;
    }
    .card{
      position:relative;
      background:linear-gradient(180deg,var(--panel2),var(--panel));
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 0 18px rgba(255,255,255,.06);
      transition:.2s;
      transform:translateY(10px);
      opacity:0;
      animation:fadeUp .55s ease forwards;
    }
    @keyframes fadeUp{ to { opacity:1; transform:translateY(0); } }
    .card:hover{
      transform:translateY(-4px) scale(1.03);
      box-shadow:0 0 45px rgba(229,9,20,.35);
      border-color:rgba(229,9,20,.35);
    }
    .thumb{ position:relative; background:#000; overflow:hidden; }
    .thumb img{
      width:100%; height:165px; object-fit:cover; display:block;
      transform:scale(1); transition:transform .25s ease;
    }
    .card:hover .thumb img{ transform:scale(1.08); }
    .badge{
      position:absolute; left:12px; bottom:12px;
      padding:8px 12px; border-radius:999px; font-weight:900;
      background:rgba(0,0,0,.65); border:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(4px);
      display:inline-flex; align-items:center; gap:8px;
    }
    .badge .dot{ width:10px; height:10px; border-radius:50%; background:var(--red); box-shadow:0 0 14px rgba(229,9,20,.8); }
    .title{ padding:14px 14px 6px; font-weight:900; text-align:center; font-size:18px; letter-spacing:.2px; }
    .meta{ padding:0 14px 14px; text-align:center; color:var(--muted); font-size:13px; line-height:1.4; }
    .card a{ text-decoration:none; color:inherit; display:block; }
    .footerWrap{ max-width:1200px; margin:40px auto 0; padding:18px 0 4px; background:linear-gradient(0deg,#000 65%, transparent); }
    .footer{ display:flex; justify-content:center; gap:12px; flex-wrap:wrap; }
    .footer a{
      display:inline-block; padding:12px 20px; border-radius:10px;
      background:#2b2b2b; color:#fff; text-decoration:none; font-weight:900; transition:.2s;
    }
    .footer a:hover{ background:var(--red); transform:scale(1.03); }

    /* Admin Bar */
    #adminBar{ position:fixed; bottom:24px; right:24px; display:flex; gap:10px; z-index:1000; }
    .adminBtn{
      background:var(--red); color:#fff; border:none;
      padding:14px 18px; border-radius:12px; font-weight:900;
      cursor:pointer; box-shadow:0 0 18px rgba(229,9,20,.6);
    }
    .adminBtn.secondary{ background:#333; box-shadow:0 0 12px rgba(255,255,255,.12); }
    .adminBtn.hidden{ display:none; }
    .delBadge{
      position:absolute; top:10px; right:10px;
      background:rgba(229,9,20,.95); color:#fff; border:none;
      border-radius:10px; padding:8px 10px; font-weight:900;
      cursor:pointer; display:none; z-index:5;
      box-shadow:0 0 14px rgba(229,9,20,.55);
    }
    body.admin .delBadge{ display:block; }

    /* Modal */
    #modal{
      position:fixed; inset:0; background:rgba(0,0,0,.85);
      display:none; align-items:center; justify-content:center; z-index:999; padding:18px;
    }
    .modal-box{
      background:#111; padding:22px; border-radius:14px;
      width:min(420px, 92vw); text-align:center;
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 0 22px rgba(255,255,255,.10);
    }
    .modal-box h2{ margin:0 0 10px; color:#fff; }
    .modal-box input{
      width:100%; margin:8px 0; padding:10px;
      border-radius:8px; outline:none; background:#0b0b0b; color:#fff;
      border:1px solid rgba(255,255,255,.08);
    }
    .modal-box button{
      width:100%; padding:10px; margin-top:8px;
      border:none; border-radius:8px; font-weight:900; cursor:pointer;
    }
    .modal-box .save{ background:var(--red); color:#fff; }
    .modal-box .cancel{ background:#444; color:#fff; }
    .hint{ margin:10px auto 0; color:rgba(255,255,255,.65); font-size:12px; line-height:1.5; text-align:left; }
    @media (max-width:900px){ .sidebar{ display:none; } .content{ padding:18px; } h1{ font-size:34px; } }
  </style>
</head>
<body>
<div class="wrap">
  <aside class="sidebar">
    <div class="submenu">
      <a href="../albums.html">Photo Albums</a>
      <a href="../MusicVideos/index.html">Music Videos</a>
      <a href="../Concerts/index.html">Concerts</a>
      <a href="../Movies/index.html">Movies</a>
      <a href="../Interviews/index.html">Interviews</a>
    </div>
    <a href="../news.html">News</a>
    <a href="../about.html">About</a>
  </aside>

  <main class="content">
    <div class="header">
      <h1>Michael Jackson Concerts</h1>
      <p class="sub">Search ‚Ä¢ Click any poster to watch</p>
    </div>

    <div class="topbar">
      <input id="q" class="search" type="text" placeholder="Search concerts..." />
    </div>

    <div id="grid" class="grid"></div>

    <div class="footerWrap">
      <div class="footer">
        <a href="../index.html">üè† Back to Home</a>
      </div>
    </div>
  </main>
</div>

<!-- Admin Bar -->
<div id="adminBar">
  <button id="loginBtn" class="adminBtn secondary" type="button">üîê Login</button>
  <button id="uploadBtn" class="adminBtn hidden" type="button">‚ûï Upload</button>
  <button id="logoutBtn" class="adminBtn secondary hidden" type="button">‚Ü© Logout</button>
</div>

<!-- Modal -->
<div id="modal">
  <div class="modal-box" id="modalBox"></div>
</div>

<!-- Supabase JS (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // ====== EDIT THESE ======
  const SUPABASE_URL = "PUT_YOUR_SUPABASE_URL_HERE";
  const SUPABASE_ANON_KEY = "PUT_YOUR_SUPABASE_ANON_PUBLIC_KEY_HERE";
  const ADMIN_EMAIL = "PUT_YOUR_EMAIL_HERE"; // ÿπÿ¥ÿßŸÜ ŸÜÿπÿ±ŸÅ ÿØŸá ÿßÿØŸÖŸÜ ŸàŸÑÿß ŸÑÿß
  // ========================

  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const grid = document.getElementById("grid");
  const q = document.getElementById("q");
  const modal = document.getElementById("modal");
  const modalBox = document.getElementById("modalBox");

  const loginBtn  = document.getElementById("loginBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function openModal(html){
    modalBox.innerHTML = html;
    modal.style.display = "flex";
  }
  function closeModal(){
    modal.style.display = "none";
    modalBox.innerHTML = "";
  }
  modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

  function setAdminUI(isAdmin){
    if(isAdmin){
      document.body.classList.add("admin");
      uploadBtn.classList.remove("hidden");
      logoutBtn.classList.remove("hidden");
      loginBtn.classList.add("hidden");
    }else{
      document.body.classList.remove("admin");
      uploadBtn.classList.add("hidden");
      logoutBtn.classList.add("hidden");
      loginBtn.classList.remove("hidden");
    }
  }

  async function isAdmin(){
    const { data } = await supa.auth.getUser();
    const email = data?.user?.email || "";
    return email.toLowerCase() === String(ADMIN_EMAIL).toLowerCase();
  }

  async function refreshAdminUI(){
    setAdminUI(await isAdmin());
  }

  function publicThumbUrl(path){
    // path ÿ≤Ÿä: "1700000000_bad-tour.jpg"
    return `${SUPABASE_URL}/storage/v1/object/public/concert-thumbs/${encodeURIComponent(path)}`;
  }

  function makeCard(row){
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.title = (row.title || "").toLowerCase();
    card.innerHTML = `
      <button class="delBadge" type="button">üóëÔ∏è Delete</button>
      <a href="${row.url}" target="_blank" rel="noopener">
        <div class="thumb">
          <img src="${publicThumbUrl(row.thumb_path)}" alt="${escapeHtml(row.title)}" onerror="this.style.opacity=.2">
          <div class="badge"><span class="dot"></span> ${escapeHtml(row.meta || "Watch")}</div>
        </div>
        <div class="title">${escapeHtml(row.title)}</div>
        <div class="meta">${escapeHtml(row.meta || "YouTube / Link")}</div>
      </a>
    `;

    const delBtn = card.querySelector(".delBadge");
    delBtn.addEventListener("click", async (ev)=>{
      ev.preventDefault(); ev.stopPropagation();
      if(!(await isAdmin())) return alert("Not allowed.");
      if(!confirm("Delete this concert?")) return;

      // 1) delete db row
      const { error: delErr } = await supa.from("concerts").delete().eq("id", row.id);
      if(delErr){ alert("Delete failed: " + delErr.message); return; }

      // 2) delete file from storage
      await supa.storage.from("concert-thumbs").remove([row.thumb_path]);

      card.remove();
      applySearch();
    });

    return card;
  }

  async function loadConcerts(){
    grid.innerHTML = "";
    const { data, error } = await supa
      .from("concerts")
      .select("*")
      .order("created_at", { ascending:false });

    if(error){
      grid.innerHTML = `<div style="color:#fff;opacity:.75;text-align:center">Error: ${escapeHtml(error.message)}</div>`;
      return;
    }

    (data || []).forEach((row, i)=>{
      const card = makeCard(row);
      card.style.animationDelay = (0.04 + i*0.04) + "s";
      grid.appendChild(card);
    });

    applySearch();
  }

  function applySearch(){
    const term = q.value.trim().toLowerCase();
    Array.from(grid.children).forEach(card=>{
      const t = card.dataset.title || "";
      card.style.display = t.includes(term) ? "" : "none";
    });
  }

  q.addEventListener("input", applySearch);

  // ===== Login modal =====
  loginBtn.addEventListener("click", ()=>{
    openModal(`
      <h2>Admin Login</h2>
      <input id="email" type="email" placeholder="Email" />
      <input id="pass" type="password" placeholder="Password" />
      <button class="save" id="doLogin" type="button">Login</button>
      <button class="cancel" id="cancel" type="button">Cancel</button>
      <div class="hint">Login ÿ®ŸäÿÆŸÑŸä Upload/Delete Ÿäÿ∏Ÿáÿ±Ÿàÿß.</div>
    `);
    document.getElementById("cancel").onclick = closeModal;
    document.getElementById("doLogin").onclick = async ()=>{
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("pass").value.trim();
      const { error } = await supa.auth.signInWithPassword({ email, password });
      if(error){ alert(error.message); return; }
      closeModal();
      await refreshAdminUI();
    };
  });

  logoutBtn.addEventListener("click", async ()=>{
    await supa.auth.signOut();
    await refreshAdminUI();
  });

  // ===== Upload modal =====
  uploadBtn.addEventListener("click", async ()=>{
    if(!(await isAdmin())) return alert("Not allowed.");
    openModal(`
      <h2>Upload New Concert</h2>
      <input id="title" type="text" placeholder="Concert Title" />
      <input id="url" type="text" placeholder="YouTube Link (or any URL)" />
      <input id="meta" type="text" placeholder="Meta (YouTube/Watch) - optional" />
      <input id="thumb" type="file" accept="image/*" />
      <button class="save" id="save" type="button">Save Concert</button>
      <button class="cancel" id="cancel" type="button">Cancel</button>
      <div class="hint">
        ÿßŸÑÿµŸàÿ±ÿ© Ÿáÿ™ÿ™ÿ±ŸÅÿπ ÿπŸÑŸâ Supabase Storage + ŸáŸäÿ™ÿ≥ÿ¨ŸÑ ÿßŸÑŸÉŸàŸÜÿ≥ÿ±Ÿπ ŸÅŸä Databaseÿå ŸàÿØŸá ŸáŸäÿ¥ÿ™ÿ∫ŸÑ ŸÑŸÑŸÜÿßÿ≥ ÿπŸÑŸâ GitHub.
      </div>
    `);

    document.getElementById("cancel").onclick = closeModal;

    document.getElementById("save").onclick = async ()=>{
      const title = document.getElementById("title").value.trim();
      const url   = document.getElementById("url").value.trim();
      const meta  = document.getElementById("meta").value.trim() || "YouTube";
      const file  = document.getElementById("thumb").files[0];

      if(!title || !url || !file){
        alert("Please add Title + Link + Thumbnail Image");
        return;
      }

      // ÿßÿ≥ŸÖ ŸÖŸÑŸÅ ÿ¢ŸÖŸÜ
      const safeName = (file.name || "thumb.jpg").replace(/[^\w.\-]+/g, "_");
      const path = `${Date.now()}_${safeName}`;

      // 1) upload to storage
      const up = await supa.storage.from("concert-thumbs").upload(path, file, { upsert:false });
      if(up.error){ alert("Upload failed: " + up.error.message); return; }

      // 2) insert row
      const ins = await supa.from("concerts").insert([{ title, url, meta, thumb_path: path }]).select().single();
      if(ins.error){
        alert("DB insert failed: " + ins.error.message);
        // ÿ≠ÿßŸàŸÑ ÿ™ŸÖÿ≥ÿ≠ ÿßŸÑÿµŸàÿ±ÿ© ŸÑŸà ÿßŸÑÿØÿßÿ™ÿßÿ®Ÿäÿ≤ ŸÅÿ¥ŸÑÿ™
        await supa.storage.from("concert-thumbs").remove([path]);
        return;
      }

      closeModal();

      // Add card top
      const card = makeCard(ins.data);
      grid.prepend(card);
      applySearch();
    };
  });

  // on load
  supa.auth.onAuthStateChange(async ()=>{ await refreshAdminUI(); });
  (async ()=>{
    await refreshAdminUI();
    await loadConcerts();
  })();
</script>
</body>
</html>
